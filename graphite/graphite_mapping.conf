# Graphite Exporter Mapping Configuration for TrueNAS
# This transforms TrueNAS Graphite metrics into cleaner Prometheus metrics
#
# TrueNAS sends metrics in format: servers.<hostname>.<category>.<metric>
# We transform these into: truenas_<category>_<metric>{host="<hostname>"}
#
# NOTE: All patterns use regex matching (match_type: "regex") because
# graphite_exporter's glob matcher doesn't support substring wildcards
# like "prefix-*" or "*-suffix". See: github.com/prometheus/graphite_exporter/issues/241

mappings:
  # ==========================================================================
  # DROP RULES - Performance Optimization
  # ==========================================================================
  # These rules drop unused metrics early (before regex matching) to reduce
  # CPU overhead by ~50%. TrueNAS sends 1000+ metrics, but dashboards only
  # use a subset. Dropping early avoids unnecessary regex processing.
  #
  # DROPPED CGROUP METRICS (~1,060 series):
  # - cgroup_*_pressure: CPU/IO/memory pressure (full/some stall)
  # - cgroup_*_stall_time: Stall duration metrics
  # - cgroup_mem_*: Detailed memory (usage_limit, utilization, pgfaults)
  # - cgroup_io_*: IO usage, serviced ops
  # - cgroup_throttled_*: CPU throttling metrics
  # KEPT: cgroup_cpu_percent (used in dashboard)
  #
  # DROPPED INTERFACE METRICS (~150+ series):
  # - net_operstate: Interface up/down state
  # - net_carrier: Carrier detect state
  # - net_duplex: Full/half duplex state
  # KEPT: interface_* (errors, octets, packets - used in dashboard)
  #
  # To re-enable any metric, comment out or remove its drop rule.
  # ==========================================================================

  # Drop cgroup pressure metrics (CPU/IO/memory)
  - match: 'servers\..*\.truenas-cgroup_(cpu_full_pressure|cpu_some_pressure|io_full_pressure|io_some_pressure|mem_full_pressure|mem_some_pressure)-.*\..*'
    match_type: "regex"
    name: "dropped_cgroup_pressure"
    action: drop

  # Drop cgroup stall time metrics
  - match: 'servers\..*\.truenas-cgroup_(cpu_full_pressure_stall_time|cpu_some_pressure_stall_time|io_full_pressure_stall_time|io_some_pressure_stall_time|memory_full_pressure_stall_time|memory_some_pressure_stall_time)-.*\..*'
    match_type: "regex"
    name: "dropped_cgroup_stall"
    action: drop

  # Drop cgroup detailed memory metrics (keep basic cgroup_mem for dashboard)
  - match: 'servers\..*\.truenas-cgroup_(mem_usage|mem_usage_limit|mem_utilization|pgfaults|writeback)-.*\..*'
    match_type: "regex"
    name: "dropped_cgroup_mem_detail"
    action: drop

  # Drop cgroup IO metrics
  - match: 'servers\..*\.truenas-cgroup_(io|serviced_ops)-.*\..*'
    match_type: "regex"
    name: "dropped_cgroup_io"
    action: drop

  # Drop cgroup throttling metrics
  - match: 'servers\..*\.truenas-cgroup_(throttled|throttled_duration|cpu_limit)-.*\..*'
    match_type: "regex"
    name: "dropped_cgroup_throttle"
    action: drop

  # Drop unused interface state metrics
  - match: 'servers\..*\.truenas-net_operstate-.*\..*'
    match_type: "regex"
    name: "dropped_interface_operstate"
    action: drop

  - match: 'servers\..*\.truenas-net_carrier-.*\..*'
    match_type: "regex"
    name: "dropped_interface_carrier"
    action: drop

  - match: 'servers\..*\.truenas-net_duplex-.*\..*'
    match_type: "regex"
    name: "dropped_interface_duplex"
    action: drop

  # ==========================================================================
  # CPU Metrics
  # ==========================================================================

  # CPU usage per core
  # Example: servers.mynas.cpu-0.cpu-idle -> cpu_usage{host="mynas",cpu="0",type="idle"}
  - match: 'servers\.([^.]+)\.cpu-([^.]+)\.cpu-([^.]+)'
    match_type: "regex"
    name: "cpu_usage"
    labels:
      host: "$1"
      cpu: "$2"
      type: "$3"

  # CPU temperature per core
  # Example: servers.mynas.cputemp-0.temperature -> cpu_temperature{host="mynas",cpu="0"}
  - match: 'servers\.([^.]+)\.cputemp-([^.]+)\.temperature'
    match_type: "regex"
    name: "cpu_temperature"
    labels:
      host: "$1"
      cpu: "$2"

  # ==========================================================================
  # System Load
  # ==========================================================================

  # Example: servers.mynas.load.load.shortterm -> system_load{host="mynas",kind="shortterm"}
  - match: 'servers\.([^.]+)\.load\.load\.([^.]+)'
    match_type: "regex"
    name: "system_load"
    labels:
      host: "$1"
      kind: "$2"

  # ==========================================================================
  # Memory Metrics
  # ==========================================================================

  # General memory stats
  # Example: servers.mynas.memory.memory-used -> memory{host="mynas",type="used"}
  - match: 'servers\.([^.]+)\.memory\.memory-([^.]+)'
    match_type: "regex"
    name: "memory"
    labels:
      host: "$1"
      type: "$2"

  # ==========================================================================
  # Disk I/O Metrics
  # ==========================================================================

  # Disk operations
  # Example: servers.mynas.disk-sda.disk_ops.read -> disk_ops{host="mynas",disk="sda",op="read"}
  - match: 'servers\.([^.]+)\.disk-([^.]+)\.disk_ops\.([^.]+)'
    match_type: "regex"
    name: "disk_ops"
    labels:
      host: "$1"
      disk: "$2"
      op: "$3"

  # Disk I/O throughput
  - match: 'servers\.([^.]+)\.disk-([^.]+)\.disk_io_time\.([^.]+)'
    match_type: "regex"
    name: "disk_io_time"
    labels:
      host: "$1"
      disk: "$2"
      type: "$3"

  # Disk octets (bytes)
  - match: 'servers\.([^.]+)\.disk-([^.]+)\.disk_octets\.([^.]+)'
    match_type: "regex"
    name: "disk_octets"
    labels:
      host: "$1"
      disk: "$2"
      direction: "$3"

  # Disk time
  - match: 'servers\.([^.]+)\.disk-([^.]+)\.disk_time\.([^.]+)'
    match_type: "regex"
    name: "disk_time"
    labels:
      host: "$1"
      disk: "$2"
      op: "$3"

  # ==========================================================================
  # Disk Temperature
  # ==========================================================================

  # Example: servers.mynas.disktemp-serial123.temperature -> disk_temperature{host="mynas",serial="serial123"}
  - match: 'servers\.([^.]+)\.disktemp-([^.]+)\.temperature'
    match_type: "regex"
    name: "disk_temperature"
    labels:
      host: "$1"
      serial: "$2"

  # ==========================================================================
  # Network Interface Metrics
  # ==========================================================================

  # Interface errors
  # Example: servers.mynas.interface-eth0.if_errors.rx -> interface_errors{host="mynas",interface="eth0",direction="rx"}
  - match: 'servers\.([^.]+)\.interface-([^.]+)\.if_errors\.([^.]+)'
    match_type: "regex"
    name: "interface_errors"
    labels:
      host: "$1"
      interface: "$2"
      direction: "$3"

  # Interface octets (traffic)
  - match: 'servers\.([^.]+)\.interface-([^.]+)\.if_octets\.([^.]+)'
    match_type: "regex"
    name: "interface_octets"
    labels:
      host: "$1"
      interface: "$2"
      direction: "$3"

  # Interface packets
  - match: 'servers\.([^.]+)\.interface-([^.]+)\.if_packets\.([^.]+)'
    match_type: "regex"
    name: "interface_packets"
    labels:
      host: "$1"
      interface: "$2"
      direction: "$3"

  # ==========================================================================
  # System Uptime
  # ==========================================================================

  # Example: servers.mynas.uptime.uptime -> uptime{host="mynas"}
  - match: 'servers\.([^.]+)\.uptime\.uptime'
    match_type: "regex"
    name: "uptime"
    labels:
      host: "$1"

  # ==========================================================================
  # Processes
  # ==========================================================================

  # Example: servers.mynas.processes.ps_state-running -> processes{host="mynas",state="running"}
  - match: 'servers\.([^.]+)\.processes\.ps_state-([^.]+)'
    match_type: "regex"
    name: "processes"
    labels:
      host: "$1"
      state: "$2"

  # ==========================================================================
  # ZFS ARC Metrics
  # ==========================================================================

  # Example: servers.mynas.zfs_arc.cache_size-current -> zfs_arc{host="mynas",cache="size",type="current"}
  - match: 'servers\.([^.]+)\.zfs_arc\.cache_([^-]+)-([^.]+)'
    match_type: "regex"
    name: "zfs_arc"
    labels:
      host: "$1"
      cache: "$2"
      type: "$3"

  # Example: servers.mynas.zfs_arc_v2.hits.value -> zfs_arc_v2{host="mynas",metric="hits"}
  - match: 'servers\.([^.]+)\.zfs_arc_v2\.([^.]+)\.value'
    match_type: "regex"
    name: "zfs_arc_v2"
    labels:
      host: "$1"
      metric: "$2"

  # ==========================================================================
  # UPS Metrics (NUT)
  # ==========================================================================

  # UPS charge
  # Example: servers.mynas.nut-ups1.percent-charge -> ups_charge_percent{host="mynas",ups="ups1"}
  - match: 'servers\.([^.]+)\.nut-([^.]+)\.percent-charge'
    match_type: "regex"
    name: "ups_charge_percent"
    labels:
      host: "$1"
      ups: "$2"

  # UPS load
  - match: 'servers\.([^.]+)\.nut-([^.]+)\.percent-load'
    match_type: "regex"
    name: "ups_load_percent"
    labels:
      host: "$1"
      ups: "$2"

  # UPS runtime
  - match: 'servers\.([^.]+)\.nut-([^.]+)\.timeleft-battery'
    match_type: "regex"
    name: "ups_runtime_seconds"
    labels:
      host: "$1"
      ups: "$2"

  # UPS voltage
  - match: 'servers\.([^.]+)\.nut-([^.]+)\.voltage-([^.]+)'
    match_type: "regex"
    name: "ups_voltage"
    labels:
      host: "$1"
      ups: "$2"
      type: "$3"

  # UPS frequency
  - match: 'servers\.([^.]+)\.nut-([^.]+)\.frequency-([^.]+)'
    match_type: "regex"
    name: "ups_frequency"
    labels:
      host: "$1"
      ups: "$2"
      type: "$3"

  # UPS temperature
  - match: 'servers\.([^.]+)\.nut-([^.]+)\.temperature'
    match_type: "regex"
    name: "ups_temperature"
    labels:
      host: "$1"
      ups: "$2"

  # ==========================================================================
  # TrueNAS-specific Metrics
  # ==========================================================================

  # Memory info (TrueNAS specific format)
  # Example: servers.mynas.truenas-meminfo-MemTotal.gauge -> truenas_meminfo{host="mynas",type="MemTotal"}
  - match: 'servers\.([^.]+)\.truenas-meminfo-([^.]+)\.gauge'
    match_type: "regex"
    name: "truenas_meminfo"
    labels:
      host: "$1"
      type: "$2"

  # Cgroup CPU usage
  # Example: servers.mynas.truenas-cgroup_cpu_percent-docker_app.percent -> cgroup_cpu_percent{host="mynas",cgroup="docker_app"}
  - match: 'servers\.([^.]+)\.truenas-cgroup_cpu_percent-([^.]+)\.percent'
    match_type: "regex"
    name: "cgroup_cpu_percent"
    labels:
      host: "$1"
      cgroup: "$2"

  # Cgroup memory
  - match: 'servers\.([^.]+)\.truenas-cgroup_mem-([^.]+)\.gauge'
    match_type: "regex"
    name: "cgroup_memory"
    labels:
      host: "$1"
      cgroup: "$2"

  # ==========================================================================
  # Catch-all for unmapped metrics (useful for debugging)
  # ==========================================================================

  # Uncomment to see unmapped metrics:
  # - match: "."
  #   match_type: regex
  #   name: "graphite_unmatched"
  #   labels:
  #     path: "$0"
