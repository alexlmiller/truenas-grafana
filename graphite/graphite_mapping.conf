# Graphite Exporter Mapping Configuration for TrueNAS
# This transforms TrueNAS Graphite metrics into cleaner Prometheus metrics
#
# TrueNAS sends metrics in format: servers.<hostname>.<category>.<metric>
# We transform these into: truenas_<category>_<metric>{host="<hostname>"}

mappings:
  # ==========================================================================
  # CPU Metrics
  # ==========================================================================

  # CPU usage per core
  - match: "servers.*.cpu-*.cpu-*"
    name: "cpu_usage"
    labels:
      host: "$1"
      cpu: "$2"
      type: "$3"

  # CPU temperature per core
  - match: "servers.*.cputemp-*.temperature"
    name: "cpu_temperature"
    labels:
      host: "$1"
      cpu: "$2"

  # ==========================================================================
  # System Load
  # ==========================================================================

  - match: "servers.*.load.load.*"
    name: "system_load"
    labels:
      host: "$1"
      kind: "$2"

  # ==========================================================================
  # Memory Metrics
  # ==========================================================================

  # General memory stats
  - match: "servers.*.memory.memory-*"
    name: "memory"
    labels:
      host: "$1"
      type: "$2"

  # ==========================================================================
  # Disk I/O Metrics
  # ==========================================================================

  # Disk operations
  - match: "servers.*.disk-*.disk_ops.*"
    name: "disk_ops"
    labels:
      host: "$1"
      disk: "$2"
      op: "$3"

  # Disk I/O throughput
  - match: "servers.*.disk-*.disk_io_time.*"
    name: "disk_io_time"
    labels:
      host: "$1"
      disk: "$2"
      type: "$3"

  # Disk octets (bytes)
  - match: "servers.*.disk-*.disk_octets.*"
    name: "disk_octets"
    labels:
      host: "$1"
      disk: "$2"
      direction: "$3"

  # Disk time
  - match: "servers.*.disk-*.disk_time.*"
    name: "disk_time"
    labels:
      host: "$1"
      disk: "$2"
      op: "$3"

  # ==========================================================================
  # Disk Temperature
  # ==========================================================================

  - match: "servers.*.disktemp-*.temperature"
    name: "disk_temperature"
    labels:
      host: "$1"
      serial: "$2"

  # ==========================================================================
  # Network Interface Metrics
  # ==========================================================================

  # Interface errors
  - match: "servers.*.interface-*.if_errors.*"
    name: "interface_errors"
    labels:
      host: "$1"
      interface: "$2"
      direction: "$3"

  # Interface octets (traffic)
  - match: "servers.*.interface-*.if_octets.*"
    name: "interface_octets"
    labels:
      host: "$1"
      interface: "$2"
      direction: "$3"

  # Interface packets
  - match: "servers.*.interface-*.if_packets.*"
    name: "interface_packets"
    labels:
      host: "$1"
      interface: "$2"
      direction: "$3"

  # ==========================================================================
  # System Uptime
  # ==========================================================================

  - match: "servers.*.uptime.uptime"
    name: "uptime"
    labels:
      host: "$1"

  # ==========================================================================
  # Processes
  # ==========================================================================

  - match: "servers.*.processes.ps_state-*"
    name: "processes"
    labels:
      host: "$1"
      state: "$2"

  # ==========================================================================
  # ZFS ARC Metrics
  # ==========================================================================

  - match: "servers.*.zfs_arc.cache_*-*"
    name: "zfs_arc"
    labels:
      host: "$1"
      cache: "$2"
      type: "$3"

  - match: "servers.*.zfs_arc_v2.*.value"
    name: "zfs_arc_v2"
    labels:
      host: "$1"
      metric: "$2"

  # ==========================================================================
  # UPS Metrics (NUT)
  # ==========================================================================

  # UPS charge
  - match: "servers.*.nut-*.percent-charge"
    name: "ups_charge_percent"
    labels:
      host: "$1"
      ups: "$2"

  # UPS load
  - match: "servers.*.nut-*.percent-load"
    name: "ups_load_percent"
    labels:
      host: "$1"
      ups: "$2"

  # UPS runtime
  - match: "servers.*.nut-*.timeleft-battery"
    name: "ups_runtime_seconds"
    labels:
      host: "$1"
      ups: "$2"

  # UPS voltage
  - match: "servers.*.nut-*.voltage-*"
    name: "ups_voltage"
    labels:
      host: "$1"
      ups: "$2"
      type: "$3"

  # UPS frequency
  - match: "servers.*.nut-*.frequency-*"
    name: "ups_frequency"
    labels:
      host: "$1"
      ups: "$2"
      type: "$3"

  # UPS temperature
  - match: "servers.*.nut-*.temperature"
    name: "ups_temperature"
    labels:
      host: "$1"
      ups: "$2"

  # ==========================================================================
  # TrueNAS-specific Metrics
  # ==========================================================================

  # Memory info (TrueNAS specific format)
  - match: "servers.*.truenas-meminfo-*.gauge"
    name: "truenas_meminfo"
    labels:
      host: "$1"
      type: "$2"

  # Cgroup CPU usage
  - match: "servers.*.truenas-cgroup_cpu_percent-*.percent"
    name: "cgroup_cpu_percent"
    labels:
      host: "$1"
      cgroup: "$2"

  # Cgroup memory
  - match: "servers.*.truenas-cgroup_mem-*.gauge"
    name: "cgroup_memory"
    labels:
      host: "$1"
      cgroup: "$2"

  # ==========================================================================
  # Catch-all for unmapped metrics (useful for debugging)
  # ==========================================================================

  # Uncomment to see unmapped metrics:
  # - match: "."
  #   match_type: regex
  #   name: "graphite_unmatched"
  #   labels:
  #     path: "$0"
